# State Ontology: Observed / Desired / Control

> **Status**: ACTIVE  
> **Created**: 2026-01-30  
> **Source**: [state-ontology-proposal.md](../sdqctl-proposals/state-ontology-proposal.md)

---

## Overview

The Nightscout ecosystem handles three fundamentally different types of state:

| Category | Definition | Sync Pattern |
|----------|------------|--------------|
| **Observed** | What actually happened | Push, immutable |
| **Desired** | What user/clinician wants | Bidirectional, mutable |
| **Control** | What algorithm recommends/enacts | Push, read-only |

Understanding which category data belongs to is critical for:
- Correct sync semantics
- Conflict resolution strategies
- Interoperability gap prioritization

---

## Category Definitions

### Observed State (What Happened)

Data representing actual events and measurements that have already occurred.

**Characteristics**:
- Immutable once recorded
- Source of truth is the device/sensor
- Historical record, cannot be "undone"
- Timestamp represents when event occurred

**Examples**:

| Collection | Field/Type | Description |
|------------|------------|-------------|
| `entries` | `sgv` | Sensor glucose value (mg/dL) |
| `entries` | `mbg` | Meter blood glucose calibration |
| `treatments` | Bolus with `insulin` | Delivered insulin units |
| `treatments` | Carb entry with `carbs` | Recorded carbohydrate intake |
| `devicestatus` | `pump.reservoir` | Actual reservoir level |
| `devicestatus` | `pump.battery` | Actual battery percentage |
| `devicestatus` | `uploader.battery` | Phone battery level |

**Sync Semantics**: 
- Source → Nightscout → Followers (unidirectional)
- Deduplication by `identifier` or composite key
- Never modified after creation (append-only)

---

### Desired State (What User Wants)

User or clinician configuration expressing therapeutic intent.

**Characteristics**:
- Mutable (can be updated)
- Requires conflict resolution on sync
- Represents configuration, not events
- May have effective time ranges

**Examples**:

| Collection | Field/Type | Description |
|------------|------------|-------------|
| `profile` | `basal` | Scheduled basal rates |
| `profile` | `carbratio` | Carb ratio schedule |
| `profile` | `sens` | Insulin sensitivity schedule |
| `profile` | `target_low/high` | Target glucose range |
| `treatments` | `Temporary Target` | User-set glucose target override |
| `treatments` | `Profile Switch` | Active profile selection |
| `treatments` | `Override Preset` | Named therapy modification |
| `settings` | Alarm thresholds | User preferences |

**Sync Semantics**:
- Bidirectional sync with last-write-wins or merge
- `syncIdentifier` for cross-system identity
- Updates replace previous values (not append)

---

### Control State (What Algorithm Decides)

Algorithm outputs, predictions, and enacted changes.

**Characteristics**:
- Generated by AID algorithm
- May be recommended or enacted
- Includes reasoning/context
- Read-only for non-controller systems

**Examples**:

| Collection | Field/Type | Description |
|------------|------------|-------------|
| `devicestatus.loop` | `predicted.values` | Glucose prediction curve |
| `devicestatus.loop` | `recommendedBolus` | Suggested bolus amount |
| `devicestatus.loop` | `enacted.rate` | Active temp basal rate |
| `devicestatus.openaps` | `iob` | Calculated insulin on board |
| `devicestatus.openaps` | `suggested` | Recommended action |
| `devicestatus.openaps` | `enacted` | Executed action |
| `treatments` | Temp Basal (`automatic: true`) | Algorithm-enacted temp |
| `treatments` | SMB (`automatic: true`) | Algorithm-enacted micro-bolus |

**Sync Semantics**:
- Controller → Nightscout (unidirectional)
- Read-only for follower apps
- High-frequency updates (every loop cycle)
- Superseded by newer values

---

## Collection Mapping

Each Nightscout collection contains fields from multiple ontology categories:

### entries

| Category | Proportion | Key Fields |
|----------|------------|------------|
| **Observed** | 100% | `sgv`, `mbg`, `cal`, `direction` |

Entries is purely observed state - sensor readings and calibrations.

### treatments

| Category | Proportion | Key Fields |
|----------|------------|------------|
| **Observed** | ~40% | Bolus, Carbs, BG Check |
| **Desired** | ~35% | Temp Target, Override, Profile Switch |
| **Control** | ~25% | Auto temp basal, SMB (`automatic: true`) |

Treatments is the most mixed collection - requires `eventType` + flags to classify.

**Classification Rules**:
```
if eventType in ["Temp Basal", "SMB"] and automatic == true:
    → Control
elif eventType in ["Temporary Target", "Override", "Profile Switch"]:
    → Desired
else:
    → Observed
```

### devicestatus

| Category | Proportion | Key Fields |
|----------|------------|------------|
| **Observed** | ~30% | `pump.*`, `uploader.*`, device telemetry |
| **Control** | ~70% | `loop.*`, `openaps.*`, algorithm state |

### profile

| Category | Proportion | Key Fields |
|----------|------------|------------|
| **Desired** | 100% | All therapy settings |

Profile is purely desired state - user/clinician configuration.

---

## Sync Pattern Summary

| Category | Direction | Mutability | Conflict Strategy |
|----------|-----------|------------|-------------------|
| Observed | Source → NS → Followers | Immutable | Dedup by ID |
| Desired | Bidirectional | Mutable | Last-write-wins / Merge |
| Control | Controller → NS | Superseded | Latest value wins |

---

## Gap Classification Guide

When classifying GAP-* IDs by ontology:

| Pattern | Typical Category | Example |
|---------|------------------|---------|
| GAP-SYNC-* | Cross-category or Observed | Deduplication issues |
| GAP-PROF-* | Desired | Profile sync conflicts |
| GAP-ALG-* | Control | Algorithm output differences |
| GAP-ENTRY-* | Observed | CGM data gaps |
| GAP-TREAT-* | Mixed | Depends on eventType |
| GAP-DS-* | Mixed | Depends on subsystem |

---

## Open Questions

1. **Recommended vs Enacted**: Should Control be split into sub-categories?
   - `Control.Recommended`: Algorithm suggestion (may not execute)
   - `Control.Enacted`: Actually executed action

2. **State Change Events**: Are Profile Switches observed or desired?
   - The switch itself is an event (observed)
   - The profile being activated is desired state

3. **Follower Apps**: Read all categories but write none
   - Special sync role: consumer-only

---

## Related Documents

- [state-ontology-proposal.md](../sdqctl-proposals/state-ontology-proposal.md) - Original proposal
- [statespan-standardization-proposal.md](../sdqctl-proposals/statespan-standardization-proposal.md) - Temporal querying
- [terminology-matrix.md](../../mapping/cross-project/terminology-matrix.md) - Term definitions
