# backlog-cycle.conv - Comprehensive backlog-driven work cycle
#
# A single workflow that:
# 1. Selects a task from backlogs (Ready Queue or domain backlogs)
# 2. Executes the appropriate analysis/work
# 3. Updates all 5 facets with findings
# 4. Grooms the backlog (move completed, replenish queue, archive stale)
# 5. Surfaces open questions for human review
# 6. Generates new tasks from discoveries
#
# Usage:
#   # Run one complete cycle
#   sdqctl iterate workflows/orchestration/backlog-cycle.conv
#
#   # Run multiple cycles
#   sdqctl iterate workflows/orchestration/backlog-cycle.conv -n 3
#
#   # With specific guidance
#   sdqctl iterate workflows/orchestration/backlog-cycle.conv \
#     --prologue "Prioritize: remote bolus comparison. Skip: openaps audit"
#
# I/O Contract:
#   INPUT:  docs/sdqctl-proposals/ECOSYSTEM-BACKLOG.md (main backlog with Ready Queue)
#           docs/sdqctl-proposals/backlogs/*.md (domain backlogs for detail)
#           LIVE-BACKLOG.md (midflight human requests - check first!)
#           User direction via --prologue (optional)
#   OUTPUT: Updated 5 facets (terminology, gaps, requirements, deep-dive, progress)
#           Updated domain backlog (completed items)
#           Updated ECOSYSTEM-BACKLOG.md (Ready Queue refreshed)
#   ESCALATE: Open questions to LIVE-BACKLOG.md

MODEL claude-sonnet-4-20250514
ADAPTER copilot
MODE analysis
CONTEXT-LIMIT 65%
ON-CONTEXT-LIMIT compact

# Load backlog state - check LIVE first for human requests, then main + domains

# === Phase 1: Task Selection ===
PROMPT ## Phase 1: Task Selection

Look in appropriate areas for backlog material
* LIVE-BACKLOG.md
* docs/sdqctl-proposals/backlogs/*
* docs/sdqctl-proposals/*

Review the current backlog state and select the next task.

**Rules:**
1. Look for taskable and ACTIVE work areas in the main backlog and select a reasonable
   chunk of work for one full iteration of the software development lifecycle.
2. Otherwise, select from Immediate Queue (priority order)
3. If Immediate Queue is empty, pull from ECOSYSTEM-BACKLOG.md Ready Queue

**Check for blockers:**
- If task needs files that don't exist, note as blocker, suraface to an
  appropriate dedicated open questions doc.
- If task depends on incomplete work, note dependency
- If task is stale (>3 cycles untouched), consider demotion

**Output:**
```markdown
### Selected Task

**Task:** [title]
**Type:** [Comparison|Extraction|Deep-Dive|Gap-Discovery|Traceability|<other-appropriate-type>]
**Source:** [which backlog/queue]
**Blocked:** [No|Yes - reason]

**Plan:**
1. [first step]
2. [second step]
3. [update facets]
```

**Update LIVE-BACKLOG.md:**
Move selected task to "Active Task" section.

COMPACT

# === Phase 2: Execute Work ===
PROMPT ## Phase 2: Execute Work

Perform the selected task based on its type.

**Work Patterns by Type:**

### Comparison Tasks
1. Search each repo for the feature/concept
2. Document differences in terminology, behavior, structure
3. Create comparison table
4. Identify gaps (inconsistencies = potential gaps)

### Extraction Tasks
1. Navigate to source path
2. Document schemas, fields, structures
3. Map to existing OpenAPI specs or create new entries
4. Note anything undocumented

### Deep-Dive Tasks
1. Explore repo structure
2. Document key components
3. Trace data flows
4. Build terminology mappings

### Gap-Discovery Tasks
1. Compare actual behavior to expectations
2. Find undocumented features
3. Find inconsistencies between systems
4. Classify gaps by severity

### Traceability Tasks
* Propose ways to create tests/harnessses or test plans in the apporpriately
  detailed documents.
1. Trace from requirement to implementation
2. Find gaps in coverage
3. Update traceability matrix

**Code References:**
Always use format: `repo:path/from/repo/root.ext:line`
Example: `LoopWorkspace:LoopKit/LoopKit/InsulinKit/InsulinMath.swift:42`

**Document findings as you work.**

COMPACT

# === Phase 3: Update 5 Facets ===
PROMPT ## Phase 3: Update 5 Facets

Update all relevant project facets based on your findings.

**Facet 1: Terminology Matrix**
File: `mapping/cross-project/terminology-matrix.md`
- Add new term mappings discovered
- Use table format: | Term | NS | Loop | AAPS | Trio | xDrip | oref0 | Notes |

**Facet 2: Gaps**
File: `traceability/gaps.md`
- Add new gaps with proper IDs: GAP-XXX-NNN
- Include: Description, Affected Systems, Impact, Remediation

**Facet 3: Requirements**
File: `traceability/requirements.md`
- Extract any requirements discovered
- Use REQ-NNN format with Statement, Rationale, Verification

**Facet 4: Deep Dive** (if applicable)
File: `docs/10-domain/{topic}-deep-dive.md`
- Add or update technical documentation
- Include code references

**Facet 5: Progress**
* Update the the open questions with any issues that are blocking or need
  clarification in the appropriate open questions document.
- Summary table of deliverables


**Be surgical - only update what changed.**

COMPACT
PROMPT ## Verification stage
If the traceability and other tools apply, let's use the available tools to
ensure that the updates we've made are accurate
Let's record our work in git as appropriate.

# === Phase 4: Groom Backlog ===
PROMPT ## Phase 4: Groom Backlog

Maintain backlog hygiene after completing work.

**Step 1: Close Active Task**
In LIVE-BACKLOG.md:
- Clear "Active Task" section
- Add entry to "Findings to Integrate" if there's doc work pending
- Or note as complete if fully integrated

**Step 2: Move to Completed**
In ECOSYSTEM-BACKLOG.md:
- Move completed item to Completed table
- Add outcome summary

**Step 3: Replenish Immediate Queue**
In LIVE-BACKLOG.md:
- If Immediate Queue < 3 items, pull from ECOSYSTEM-BACKLOG.md Ready Queue
- If Ready Queue < 3 items, promote from Backlog

**Step 4: Generate New Tasks** (if applicable)
From discoveries in Phase 2/3:
- New gaps → may warrant new backlog items
- New terminology domains → may need mapping work
- Blockers found → create follow-up items

Add new items to ECOSYSTEM-BACKLOG.md at appropriate priority.
Consider related backlogs listed in LIVE-BACKLOG.md.

**Step 5: Identify Stale Items**
Items not touched in 3+ cycles:
- Demote priority, or
- Move to OPEN-QUESTIONS.md as blocked, or
- Archive if no longer relevant

**Step 6: Surface Open Questions**
Any decisions needed from human:
- Add to LIVE-BACKLOG.md "Open Questions" section
- Include context and options

COMPACT

PROMPT Documentation quality
Do not let backlog[s] or other progress or tracker document exceed 1000 lines.
Ensure that the knowledge and updates from finished work are well integrated
into appropriate documenation across the project, keep backlog queues limited
to under 500 lines while allowing them to refer to other detailed documents or
proposals for upcoming or recent work, while appropriately archiving old
interstitial, duplicative, or bloated material.

Integrate any relevant information we learned into more detailed proposals if
appropriate.
If appropriate, integrate feedback from what we've learned or maintenance
issues back into the backlog.  For example, if certain documentation should be
audited or new repos are underdocumented, insert an appropriate backlog item
somewhere to be included in future development.  Consider if any recent work
can add context to proposals or gives yields insight into additional
integration or alignment ideas at the product or process level.

PROMPT ## Phase 5: Cycle Summary

# === Phase 5: Cycle Summary ===
PROMPT ## Phase 5: Cycle Summary

Summarize what was accomplished and what's next.

**Output:**
```markdown
### Backlog Cycle Complete

**Task Completed:** [title]
**Type:** [type]

**Facets Updated:**
- [ ] terminology-matrix.md: [N terms added/updated]
- [ ] gaps.md: [N gaps added]
- [ ] requirements.md: [N requirements added]
- [ ] {topic}-deep-dive.md: [description]

**Backlog Changes:**
- Completed: [task moved to Completed table]
- New items: [N items generated from discoveries]
- Replenished: [items promoted to Immediate Queue]
- Stale: [items demoted/archived]

**Open Questions Surfaced:** [N]

Important, record our work in git as appropriate.

**Next Immediate Queue:**
1. [task 1]
2. [task 2]
3. [task 3]

**Ready for next cycle:** [Yes|No - reason]
```


COMPACT
